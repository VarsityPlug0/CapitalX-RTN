{% extends "base.html" %}

{% block title %}Lead Analytics - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">üìä Lead Analytics</h1>
            <p class="text-muted">Performance metrics and insights for your lead campaigns</p>
        </div>
        <a href="{% url 'lead_dashboard' %}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-0">Total Campaigns</h6>
                            <h2 class="text-primary">{{ total_campaigns }}</h2>
                        </div>
                        <div class="stat-icon bg-primary">
                            <i class="bi bi-folder2-open"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-0">Total Leads</h6>
                            <h2 class="text-info">{{ total_leads }}</h2>
                        </div>
                        <div class="stat-icon bg-info">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-0">Emails Sent</h6>
                            <h2 class="text-success">{{ total_emails_sent }}</h2>
                        </div>
                        <div class="stat-icon bg-success">
                            <i class="bi bi-envelope-check"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-muted mb-0">Success Rate</h6>
                            <h2 class="text-warning">{{ overall_success_rate }}%</h2>
                        </div>
                        <div class="stat-icon bg-warning">
                            <i class="bi bi-graph-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Campaign Performance -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üìà Campaign Performance</h5>
                </div>
                <div class="card-body">
                    {% if campaign_stats %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Campaign</th>
                                    <th>Total Leads</th>
                                    <th>Successful</th>
                                    <th>Success Rate</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for campaign in campaign_stats %}
                                <tr>
                                    <td>
                                        <strong>{{ campaign.name }}</strong>
                                        {% if campaign.description %}
                                        <br><small class="text-muted">{{ campaign.description|truncatechars:40
                                            }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ campaign.lead_count }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ campaign.successful_leads }}</span>
                                    </td>
                                    <td>
                                        {% with rate=campaign.successful_leads|divisibleby:campaign.lead_count %}
                                        <div class="progress" style="height: 20px;">
                                            {% if campaign.lead_count > 0 %}
                                            {% widthratio campaign.successful_leads campaign.lead_count 100 as
                                            success_rate %}
                                            <div class="progress-bar bg-{% if success_rate >= 50 %}success{% elif success_rate >= 25 %}warning{% else %}danger{% endif %}"
                                                role="progressbar" style="width: {{ success_rate }}%">
                                                {{ success_rate }}%
                                            </div>
                                            {% else %}
                                            <div class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                                            {% endif %}
                                        </div>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        {% if campaign.is_active %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-bar-chart-line display-1 text-muted"></i>
                        <h5 class="mt-3">No campaign data yet</h5>
                        <p class="text-muted">Create campaigns and process leads to see performance metrics</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Monthly Trends -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìÖ Monthly Trends (Last 6 Months)</h5>
                </div>
                <div class="card-body">
                    {% if monthly_stats %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Total Leads</th>
                                    <th>Successful</th>
                                    <th>Success Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in monthly_stats %}
                                <tr>
                                    <td>{{ stat.month|date:"F Y" }}</td>
                                    <td><span class="badge bg-info">{{ stat.total }}</span></td>
                                    <td><span class="badge bg-success">{{ stat.successful }}</span></td>
                                    <td>
                                        {% if stat.total > 0 %}
                                        {% widthratio stat.successful stat.total 100 as month_rate %}
                                        <span
                                            class="badge bg-{% if month_rate >= 50 %}success{% elif month_rate >= 25 %}warning{% else %}danger{% endif %}">
                                            {{ month_rate }}%
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-calendar3 display-4 text-muted"></i>
                        <p class="text-muted mt-2">No monthly data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Domain Analysis -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üåê Top Domains</h5>
                </div>
                <div class="card-body">
                    {% if domain_stats %}
                    <div class="domain-list">
                        {% for domain in domain_stats %}
                        <div class="domain-item mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong>{{ domain.domain }}</strong>
                                <span class="badge bg-info">{{ domain.total }} leads</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                {% if domain.total > 0 %}
                                {% widthratio domain.successful domain.total 100 as domain_rate %}
                                <div class="progress-bar bg-success" role="progressbar"
                                    style="width: {{ domain_rate }}%"></div>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                {{ domain.successful }} successful
                                {% if domain.total > 0 %}
                                ({% widthratio domain.successful domain.total 100 %}%)
                                {% endif %}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-globe display-4 text-muted"></i>
                        <p class="text-muted mt-2">No domain data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">‚ö° Quick Stats</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Successful Leads</span>
                        <strong class="text-success">{{ successful_leads }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Failed Leads</span>
                        <strong class="text-danger">{{ total_leads|add:"-"|add:successful_leads }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Conversion Rate</span>
                        <strong class="text-primary">{{ overall_success_rate }}%</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .stat-card {
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .domain-item {
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #eee;
    }

    .domain-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
</style>
{% endblock %}