{% extends "base.html" %}

{% block title %}{{ campaign.name }} - Lead Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'lead_manager_dashboard' %}">Lead Manager</a></li>
                    <li class="breadcrumb-item active">{{ campaign.name }}</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">{{ campaign.name }}</h1>
            <p class="text-muted">{{ campaign.description|default:"No description provided" }}</p>
        </div>
        <div>
            {% if pending_leads > 0 %}
            <button class="btn btn-success me-2" onclick="processAllLeads()" id="processBtn">
                <i class="bi bi-play-circle"></i> Process {{ pending_leads }} Leads
            </button>
            {% endif %}
            <button class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#addLeadsModal">
                <i class="bi bi-plus"></i> Add More Leads
            </button>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-gear"></i> Actions
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="toggleCampaignStatus()">
                        <i class="bi bi-{% if campaign.is_active %}pause{% else %}play{% endif %}-circle"></i>
                        {% if campaign.is_active %}Deactivate{% else %}Activate{% endif %} Campaign
                    </a></li>
                    <li><a class="dropdown-item" href="{% url 'export_results' campaign.id %}">
                        <i class="bi bi-download"></i> Export Results
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteCampaign()">
                        <i class="bi bi-trash"></i> Delete Campaign
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Campaign Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h5 class="text-primary">{{ total_leads }}</h5>
                    <small class="text-muted">Total Leads</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h5 class="text-warning">{{ pending_leads }}</h5>
                    <small class="text-muted">Pending</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h5 class="text-info">{{ processing_leads }}</h5>
                    <small class="text-muted">Processing</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h5 class="text-success">{{ successful_leads }}</h5>
                    <small class="text-muted">Successful</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h5 class="text-primary">{{ total_emails_sent }}</h5>
                    <small class="text-muted">Emails Sent</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h5 class="text-success">{{ success_rate|floatformat:1 }}%</h5>
                    <small class="text-muted">Success Rate</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar (Hidden by default) -->
    <div id="progressContainer" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-gear-fill"></i> Processing Leads...
                    </h6>
                    <div class="progress mb-2">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small id="progressText">Initializing...</small>
                        <small id="progressPercent">0%</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Leads Table -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìã Campaign Leads</h5>
                    <div class="d-flex gap-2">
                        <!-- Search -->
                        <form method="get" class="d-flex">
                            <input type="hidden" name="status" value="{{ status_filter }}">
                            <input type="search" class="form-control form-control-sm" 
                                   name="search" value="{{ search_query }}" placeholder="Search leads...">
                            <button type="submit" class="btn btn-sm btn-outline-primary ms-1">
                                <i class="bi bi-search"></i>
                            </button>
                        </form>
                        
                        <!-- Status Filter -->
                        <select class="form-select form-select-sm" onchange="filterByStatus(this.value)">
                            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>Processing</option>
                            <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if leads %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Lead</th>
                                    <th>Domain</th>
                                    <th>Status</th>
                                    <th>Valid Emails</th>
                                    <th>Emails Sent</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in leads %}
                                <tr>
                                    <td>
                                        <strong>{{ lead.first_name }} {{ lead.last_name }}</strong>
                                        {% if lead.error_message %}
                                        <br><small class="text-danger">{{ lead.error_message|truncatechars:50 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ lead.domain }}</span>
                                    </td>
                                    <td>
                                        {% if lead.status == 'pending' %}
                                        <span class="badge bg-warning">‚è≥ Pending</span>
                                        {% elif lead.status == 'processing' %}
                                        <span class="badge bg-info">üîÑ Processing</span>
                                        {% elif lead.status == 'completed' %}
                                        <span class="badge bg-{% if lead.success %}success{% else %}danger{% endif %}">
                                            {% if lead.success %}‚úÖ Success{% else %}‚ùå Failed{% endif %}
                                        </span>
                                        {% elif lead.status == 'failed' %}
                                        <span class="badge bg-danger">‚ùå Failed</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if lead.valid_emails %}
                                        <span class="badge bg-success">{{ lead.valid_emails|length }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if lead.emails_sent %}
                                        <span class="badge bg-primary">{{ lead.emails_sent|length }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ lead.created_at|date:"M d, H:i" }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if leads.has_other_pages %}
                    <div class="card-footer">
                        <nav>
                            <ul class="pagination pagination-sm justify-content-center mb-0">
                                {% if leads.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ leads.previous_page_number }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
                                </li>
                                {% endif %}
                                
                                {% for num in leads.paginator.page_range %}
                                {% if leads.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                                {% elif num > leads.number|add:'-3' and num < leads.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                                </li>
                                {% endif %}
                                {% endfor %}
                                
                                {% if leads.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ leads.next_page_number }}{% if status_filter != 'all' %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h5 class="mt-3">No leads found</h5>
                        <p class="text-muted">
                            {% if search_query or status_filter != 'all' %}
                            Try adjusting your search or filter criteria.
                            {% else %}
                            This campaign doesn't have any leads yet.
                            {% endif %}
                        </p>
                        {% if not search_query and status_filter == 'all' %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLeadsModal">
                            <i class="bi bi-plus"></i> Add Leads
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Activity Panel -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">üìà Recent Activity</h5>
                </div>
                <div class="card-body">
                    {% if recent_emails %}
                    <div class="activity-list">
                        {% for email in recent_emails %}
                        <div class="activity-item">
                            <div class="activity-icon bg-success">
                                <i class="bi bi-envelope-check"></i>
                            </div>
                            <div class="activity-content">
                                <p class="mb-1"><strong>Email sent</strong></p>
                                <p class="mb-0 text-muted small">{{ email.email_address }}</p>
                                <small class="text-muted">{{ email.sent_at|timesince }} ago</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clock-history display-4 text-muted"></i>
                        <p class="text-muted mt-2">No activity yet</p>
                        {% if pending_leads > 0 %}
                        <button class="btn btn-sm btn-primary" onclick="processAllLeads()">
                            Start Processing
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Campaign Info -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0">‚ÑπÔ∏è Campaign Info</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-5">Status:</dt>
                        <dd class="col-sm-7">
                            {% if campaign.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5">Created:</dt>
                        <dd class="col-sm-7">{{ campaign.created_at|date:"M d, Y H:i" }}</dd>
                        
                        <dt class="col-sm-5">Success Rate:</dt>
                        <dd class="col-sm-7">{{ success_rate|floatformat:1 }}%</dd>
                        
                        <dt class="col-sm-5">Email Rate:</dt>
                        <dd class="col-sm-7">{{ email_success_rate|floatformat:1 }}%</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add More Leads Modal -->
<div class="modal fade" id="addLeadsModal" tabindex="-1" aria-labelledby="addLeadsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addLeadsModalLabel">
                    <i class="bi bi-plus-circle"></i> Add More Leads
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="additionalCount" class="form-label">Number of Additional Leads</label>
                    <select class="form-select" id="additionalCount">
                        <option value="">Select count...</option>
                        <option value="10">10 leads</option>
                        <option value="25">25 leads</option>
                        <option value="50">50 leads</option>
                        <option value="100">100 leads</option>
                        <option value="250">250 leads</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    This will generate additional leads with realistic names and domains for this campaign.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addMoreLeads()">
                    <i class="bi bi-plus"></i> Generate Leads
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.activity-list {
    max-height: 300px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: start;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
}

.activity-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.activity-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.9rem;
    margin-right: 12px;
    flex-shrink: 0;
}

.activity-content {
    flex: 1;
}
</style>

<script>
let currentOperationId = null;

function processAllLeads() {
    const btn = document.getElementById('processBtn');
    const originalText = btn.innerHTML;
    
    // Show progress
    document.getElementById('progressContainer').style.display = 'block';
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
    
    // Start processing
    fetch('{% url "process_campaign_leads" campaign.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentOperationId = data.operation_id;
            
            // Start progress polling
            pollProgress();
            
            // Show success message after completion
            setTimeout(() => {
                showToast('success', data.message);
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }, 3000);
        } else {
            showToast('error', data.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
            document.getElementById('progressContainer').style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'An error occurred while processing leads.');
        btn.disabled = false;
        btn.innerHTML = originalText;
        document.getElementById('progressContainer').style.display = 'none';
    });
}

function pollProgress() {
    if (!currentOperationId) return;
    
    fetch(`/api/leads/progress/${currentOperationId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'running') {
            const percent = data.progress_percent || 0;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = Math.round(percent) + '%';
            document.getElementById('progressText').textContent = data.message || 'Processing...';
            
            // Continue polling
            setTimeout(pollProgress, 2000);
        } else if (data.status === 'completed') {
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressPercent').textContent = '100%';
            document.getElementById('progressText').textContent = 'Completed!';
            
            // Hide progress after delay
            setTimeout(() => {
                document.getElementById('progressContainer').style.display = 'none';
            }, 3000);
        } else if (data.status === 'failed') {
            document.getElementById('progressText').textContent = 'Processing failed: ' + data.message;
            document.getElementById('progressBar').classList.add('bg-danger');
        }
    })
    .catch(error => {
        console.error('Progress polling error:', error);
    });
}

function addMoreLeads() {
    const count = document.getElementById('additionalCount').value;
    if (!count) {
        showToast('warning', 'Please select the number of leads to generate.');
        return;
    }
    
    fetch('{% url "generate_more_leads" campaign.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ count: parseInt(count) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', data.message);
        }
        $('#addLeadsModal').modal('hide');
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'An error occurred while generating leads.');
    });
}

function toggleCampaignStatus() {
    fetch('{% url "toggle_campaign_status" campaign.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('error', 'Failed to update campaign status.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'An error occurred.');
    });
}

function deleteCampaign() {
    if (confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "delete_campaign" campaign.id %}';
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function filterByStatus(status) {
    const url = new URL(window.location);
    if (status === 'all') {
        url.searchParams.delete('status');
    } else {
        url.searchParams.set('status', status);
    }
    url.searchParams.delete('page'); // Reset pagination
    window.location = url;
}

function showToast(type, message) {
    // Create toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Add to toast container (create if doesn't exist)
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(container);
    }
    
    container.insertAdjacentHTML('beforeend', toastHtml);
    const toast = new bootstrap.Toast(container.lastElementChild);
    toast.show();
}
</script>
{% endblock %}
